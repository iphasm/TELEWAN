#!/usr/bin/env python3
"""
Setup script for Railway Event-Driven Bot
Configura las variables de entorno necesarias para el bot event-driven
"""
import os
import sys
from pathlib import Path

def setup_railway_env():
    """Configura las variables de entorno para Railway"""

    print("ğŸš€ ConfiguraciÃ³n del Bot TELEWAN para Railway (Event-Driven)")
    print("=" * 60)

    # Verificar si ya existe .env
    env_file = Path('.env')
    if env_file.exists():
        print("âš ï¸  Archivo .env encontrado. Respaldando...")
        backup_file = Path('.env.backup')
        if backup_file.exists():
            backup_file.unlink()
        env_file.rename(backup_file)
        print("âœ… Backup creado: .env.backup")

    # Variables requeridas
    required_vars = [
        'TELEGRAM_BOT_TOKEN',
        'WAVESPEED_API_KEY'
    ]

    # Variables opcionales con valores por defecto
    optional_vars = {
        'USE_WEBHOOK': 'true',
        'WEBHOOK_PATH': '/webhook',
        'WEBHOOK_PORT': '8080',
        'ALLOWED_USER_ID': '',  # VacÃ­o = permite a todos
        'DEFAULT_MODEL': 'ultra_fast',
        'VOLUME_PATH': './storage'
    }

    print("\nğŸ“ Variables requeridas:")
    env_content = []

    for var in required_vars:
        value = os.getenv(var)
        if value:
            print(f"âœ… {var}: Configurada")
            env_content.append(f"{var}={value}")
        else:
            print(f"âŒ {var}: NO CONFIGURADA")
            print(f"   â„¹ï¸  Configure esta variable en Railway Dashboard")
            env_content.append(f"{var}=tu_{var.lower()}_aqui")

    print("\nğŸ“‹ Variables opcionales (con valores por defecto):")
    for var, default in optional_vars.items():
        value = os.getenv(var, default)
        print(f"âœ… {var}: {value}")
        env_content.append(f"{var}={value}")

    # Variables adicionales para Railway
    railway_vars = {
        'REDIS_URL': 'redis://localhost:6379',  # Railway proporciona Redis
        'WEBHOOK_SECRET_TOKEN': '',  # Opcional para seguridad adicional
    }

    print("\nğŸ”§ Variables especÃ­ficas de Railway:")
    for var, default in railway_vars.items():
        value = os.getenv(var, default)
        if var == 'REDIS_URL' and not value.startswith('redis://'):
            print(f"âš ï¸  {var}: Railway deberÃ­a proporcionar Redis automÃ¡ticamente")
        else:
            print(f"âœ… {var}: {'Configurada' if value != default else 'Usando default'}")
        env_content.append(f"{var}={value}")

    # Crear archivo .env
    print("\nğŸ’¾ Creando archivo .env...")
    with open('.env', 'w', encoding='utf-8') as f:
        f.write("# ConfiguraciÃ³n para TELEWAN Bot (Event-Driven Architecture)\n")
        f.write("# Generado automÃ¡ticamente por setup_railway_eventdriven.py\n\n")
        f.write("# Variables requeridas - CONFIGURAR EN RAILWAY DASHBOARD\n")
        for var in required_vars:
            f.write(f"{var}=tu_{var.lower()}_aqui\n")
        f.write("\n# Variables opcionales\n")
        for var, default in optional_vars.items():
            f.write(f"{var}={default}\n")
        f.write("\n# Variables especÃ­ficas de Railway\n")
        for var, default in railway_vars.items():
            f.write(f"{var}={default}\n")

    print("âœ… Archivo .env creado")

    # Verificar dependencias
    print("\nğŸ” Verificando dependencias...")
    try:
        import fastapi
        import uvicorn
        import aiohttp
        import redis
        print("âœ… Todas las dependencias instaladas")
    except ImportError as e:
        print(f"âŒ Dependencia faltante: {e}")
        print("Ejecuta: pip install -r requirements.txt")
        return False

    # Verificar configuraciÃ³n
    print("\nâš™ï¸  Verificando configuraciÃ³n...")
    try:
        from config import Config
        Config.validate()
        print("âœ… ConfiguraciÃ³n vÃ¡lida")
    except ValueError as e:
        print(f"âŒ Error de configuraciÃ³n: {e}")
        return False

    # Mostrar instrucciones finales
    print("\n" + "=" * 60)
    print("ğŸ¯ CONFIGURACIÃ“N COMPLETA")
    print("=" * 60)
    print()
    print("Para completar la configuraciÃ³n:")
    print()
    print("1. ğŸš€ Despliega en Railway:")
    print("   git push origin feature/event-driven")
    print()
    print("2. âš™ï¸  Configura variables en Railway Dashboard:")
    print("   - TELEGRAM_BOT_TOKEN: Tu token de @BotFather")
    print("   - WAVESPEED_API_KEY: Tu API key de WaveSpeed")
    print("   - WEBHOOK_URL: URL proporcionada por Railway")
    print()
    print("3. ğŸ® El bot responderÃ¡ automÃ¡ticamente a:")
    print("   - /start, /help, /models")
    print("   - /optimize, /preview, /quality")
    print("   - ImÃ¡genes con captions")
    print()
    print("4. ğŸ“Š Monitoreo disponible en:")
    print("   - /health: Estado del sistema")
    print("   - /stats: EstadÃ­sticas de uso")
    print()
    print("âœ… Â¡Bot listo para usar!")
    print()

    return True

if __name__ == "__main__":
    success = setup_railway_env()
    if not success:
        sys.exit(1)
